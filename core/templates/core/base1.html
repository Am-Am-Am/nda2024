{% load static %}
{% load infoblock_tag %}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% block title %}
   
    {% endblock%}
    <link rel="shortcut icon" href="{% static 'images/favicon/favicon.ico' %}" type="image/x-icon">

    {% block metatag %}
    
    {% endblock %}
    

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://smartcaptcha.yandexcloud.net/captcha.js" async defer></script>
    <script src="{% static 'htmx/htmx.min.js' %}"></script>

    {% block links %}
    
    {% endblock  %}

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        crossorigin="anonymous"></script>

        <link rel="stylesheet" type="text/css"
        href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick.min.css" />
    <link rel="stylesheet" type="text/css"
        href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick-theme.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick.min.js"></script>
    <script src="https://www.google.com/recaptcha/api.js"></script>

    <link rel="stylesheet" href="{% static 'css/style.css'%}" type="text/css">
    <link rel="stylesheet" href="{% static 'css/media.css'%}" type="text/css">
    {% block styles %}

    {% endblock %}
   
    
</head>

<body hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
    {% block content%}

    {% endblock %}  

    {% block script%}
    
    {% endblock%}

    {% include "core/components/footer.html" %}
    <script src="{% static 'scripts/indexCarouselInfo.js' %}"></script>
    <script src="{% static 'scripts/indexCarouselSubheader.js' %}"></script>
    <script src="{% static 'scripts/formController.js' %}"></script>
    <script src="{% static "scripts/buttonInFormController.js" %}"></script>
    <script src="{% static "scripts/tableScript.js" %}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const forms = document.querySelectorAll('#mail_form, #call_form');
        
            forms.forEach(form => {
                form.addEventListener('submit', function(event) {
                    event.preventDefault();
                    submitForm(form);
                });
            });
        
            async function submitForm(form) {
                const formData = new FormData(form);
                const formError = form.querySelector('#form-error');
                const modalId = form.closest('.modal').id;
        
        
                try {
                    const response = await fetch(form.action, {
                        method: 'POST',
                        body: formData,
                    });
        
        
                     if (response.ok) {
                        if (response.status === 204) {
                            const modal = document.getElementById(modalId);
                            if (modal) {
                                const modalInstance = bootstrap.Modal.getInstance(modal);
                                modalInstance.hide();
                                formError.textContent = "";
                            }
                        } else {
                           const responseData = await response.text();
                            const modal = document.getElementById(modalId);
                             if(modal) {
                                    const parser = new DOMParser();
                                   const newDocument = parser.parseFromString(responseData, 'text/html');
                                    const formContainer = newDocument.querySelector(`#${modalId} #${form.id}_container`);
                                   const newFormError = newDocument.querySelector(`#${modalId} #form-error`);
                                 const currentFormContainer = form.querySelector(`#${form.id}_container`);
                                   const currentFormError = form.querySelector('#form-error');
                                  currentFormContainer.innerHTML = formContainer.innerHTML;
                                   if (newFormError) {
                                        currentFormError.textContent = newFormError.textContent;
                                     }
                            }
        
                        }
        
                    } else {
                         const responseData = await response.text();
                            const modal = document.getElementById(modalId);
                            if(modal) {
                                const parser = new DOMParser();
                                 const newDocument = parser.parseFromString(responseData, 'text/html');
                                  const formContainer = newDocument.querySelector(`#${modalId} #${form.id}_container`);
                                  const newFormError = newDocument.querySelector(`#${modalId} #form-error`);
                                   const currentFormContainer = form.querySelector(`#${form.id}_container`);
                                 const currentFormError = form.querySelector('#form-error');
                                  currentFormContainer.innerHTML = formContainer.innerHTML;
                                 if (newFormError) {
                                    currentFormError.textContent = newFormError.textContent;
                                     }
                            }
                    }
                } catch (error) {
                    console.error('Error during form submission:', error);
                     formError.textContent = "Произошла ошибка при отправке запроса";
                }
            }
        });
        
    </script>
</body>